name: Backend CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/ci-cd.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'

env:
  PYTHON_VERSION: '3.11'
  AWS_REGION: us-east-1

jobs:
  # ========================================
  # JOB 1: Lint e FormataÃ§Ã£o
  # ========================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        working-directory: backend
        run: |
          pip install ruff black mypy

      - name: Run Ruff (linter)
        working-directory: backend
        run: |
          ruff check src/ --output-format=github
        continue-on-error: false

      - name: Check Black formatting
        working-directory: backend
        run: |
          black --check src/
        continue-on-error: false

      - name: Run MyPy (type checking)
        working-directory: backend
        run: |
          mypy src/ --ignore-missing-imports
        continue-on-error: true

  # ========================================
  # JOB 2: Testes
  # ========================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run pytest (unit tests)
        working-directory: backend
        run: |
          pytest tests/unit \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            -v

      - name: Upload coverage to Codecov (optional)
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # ========================================
  # JOB 3: Deploy DEV (automÃ¡tico)
  # ========================================
  deploy-dev:
    name: ðŸš€ Deploy to DEV
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: development
      url: https://62dv6tdqh1.execute-api.us-east-1.amazonaws.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js (for Serverless)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Serverless Framework
        working-directory: backend
        run: |
          npm install -g serverless
          npm ci 2>/dev/null || npm install

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to AWS (dev)
        working-directory: backend
        run: |
          serverless deploy --stage dev --verbose

      - name: Deployment Summary
        run: |
          echo "### Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** https://62dv6tdqh1.execute-api.us-east-1.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** dev" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # JOB 4: Deploy PROD (manual/tag)
  # ========================================
  deploy-prod:
    name: ðŸŒŸ Deploy to PRODUCTION
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://62dv6tdqh1.execute-api.us-east-1.amazonaws.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Serverless Framework
        working-directory: backend
        run: |
          npm install -g serverless
          npm ci 2>/dev/null || npm install

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to AWS (prod)
        working-directory: backend
        run: |
          serverless deploy --stage prod --verbose

      - name: Production Deployment Summary
        run: |
          echo "### PRODUCTION Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## Release ${{ github.ref_name }}
            
            ### Changes
            Automated deployment to production
            
            ### Deployment Info
            - **Stage:** production
            - **Region:** ${{ env.AWS_REGION }}
            - **Deployed:** ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
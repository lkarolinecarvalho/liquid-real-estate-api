service: financing-simulator

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  
  memorySize: 512
  timeout: 30
  
  # CORS global para HTTP API
  httpApi:
    cors: true
  
  # Variáveis de ambiente
  environment:
    STAGE: ${self:provider.stage}
    LOG_LEVEL: INFO
    BACEN_API_URL: https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados/ultimos/1?formato=json
    IBGE_API_URL: https://servicodados.ibge.gov.br/api/v3/agregados/1737/periodos/last/variaveis/2266
    API_TIMEOUT: "3"
    TAXA_BASE_ANUAL: "10.0"
    TAXA_MEDIA_NACIONAL: "9.80"
    DYNAMODB_TABLE: ${self:custom.dynamoTableName}
  
  # Permissões IAM básicas
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"
        
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoTableName}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoTableName}/index/*

custom:
  dynamoTableName: financing-simulations-${self:provider.stage}

# Funções Lambda
functions:
  simulate:
    handler: src.handlers.financing_handler.handler
    description: Simula financiamento imobiliário
    layers:
      - arn:aws:lambda:us-east-1:533267016725:layer:financing-simulator-deps:4
    events:
      - httpApi:
          path: /financing/simulate
          method: post
  getHistory:
    handler: src.handlers.history_handler.handler
    description: Busca histórico de simulações
    layers:
      - arn:aws:lambda:us-east-1:533267016725:layer:financing-simulator-deps:4
    events:
      - httpApi:
          path: /financing/history
          method: get
          cors:
            allowOrigins:
              - '*'
  
  getSimulation:
    handler: src.handlers.history_handler.get_by_id
    description: Busca simulação específica por ID
    layers:
      - arn:aws:lambda:us-east-1:533267016725:layer:financing-simulator-deps:4
    events:
      - httpApi:
          path: /financing/simulation/{id}
          method: get
          cors:
            allowOrigins:
              - '*'
  
  health:
    handler: src.handlers.health_handler.handler
    description: Health check
    events:
      - httpApi:
          path: /health
          method: get

resources:
  Resources:
    FinancingSimulationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.dynamoTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: simulation_id
            AttributeType: S
          - AttributeName: created_at
            AttributeType: S
          - AttributeName: user_identifier
            AttributeType: S
        KeySchema:
          - AttributeName: simulation_id
            KeyType: HASH
          - AttributeName: created_at
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: UserIndex
            KeySchema:
              - AttributeName: user_identifier
                KeyType: HASH
              - AttributeName: created_at
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

# Package - o que incluir no deploy
package:
  patterns:
    - '!.git/**'
    - '!.github/**'
    - '!.vscode/**'
    - '!.pytest_cache/**'
    - '!__pycache__/**'
    - '!node_modules/**'
    - '!venv/**'
    - '!tests/**'
    - '!*.md'
    - 'src/**'